name: PR Review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    name: Claude Review
    # Only run on PR comments containing /review
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/review')
    runs-on: ubuntu-latest

    steps:
      - name: Acknowledge review request
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('base_sha', pr.data.base.sha);
            return pr.data;

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.pr.outputs.head_sha }}

      - name: Get diff and save to file
        run: |
          git diff ${{ steps.pr.outputs.base_sha }}..${{ steps.pr.outputs.head_sha }} -- '*.ts' '*.tsx' '*.js' '*.jsx' > /tmp/diff.txt

      - name: Security Review
        id: security
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('/tmp/diff.txt', 'utf8');

            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 1024,
                messages: [{
                  role: 'user',
                  content: "You are a security-focused code reviewer. Review this diff for security issues ONLY.\n\nFocus on:\n- Injection vulnerabilities (SQL, command, XSS)\n- Secrets/credentials exposure\n- Authentication/authorization issues\n- Input validation problems\n- Insecure dependencies or patterns\n\nBe concise. If no security issues found, say \"No security issues identified.\"\nFormat issues as a markdown list with severity (High/Medium/Low).\n\nDiff:\n```diff\n" + diff + "\n```"
                }]
              })
            });
            const data = await response.json();
            if (data.error) {
              console.log('API Error:', JSON.stringify(data.error));
              return 'Error calling Claude API: ' + data.error.message;
            }
            return data.content[0].text;
          result-encoding: string

      - name: Architecture Review
        id: architecture
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('/tmp/diff.txt', 'utf8');

            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 1024,
                messages: [{
                  role: 'user',
                  content: "You are an architecture-focused code reviewer for a DDD-based Node.js project.\n\nReview this diff for architectural concerns ONLY.\n\nFocus on:\n- Domain-Driven Design adherence\n- Separation of concerns\n- Module boundaries and dependencies\n- Pattern consistency (repository, service, provider patterns)\n- Abstraction layers\n\nBe concise. If architecture looks good, acknowledge what's done well briefly.\nFormat issues as a markdown list.\n\nDiff:\n```diff\n" + diff + "\n```"
                }]
              })
            });
            const data = await response.json();
            if (data.error) {
              console.log('API Error:', JSON.stringify(data.error));
              return 'Error calling Claude API: ' + data.error.message;
            }
            return data.content[0].text;
          result-encoding: string

      - name: Code Quality Review
        id: quality
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('/tmp/diff.txt', 'utf8');

            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 1024,
                messages: [{
                  role: 'user',
                  content: "You are a code quality reviewer for a TypeScript Node.js project.\n\nReview this diff for code quality ONLY.\n\nFocus on:\n- TypeScript best practices and type safety\n- Error handling\n- Naming conventions and readability\n- Code duplication\n- Edge cases\n\nBe concise. Highlight both issues and good practices.\nFormat as a markdown list.\n\nDiff:\n```diff\n" + diff + "\n```"
                }]
              })
            });
            const data = await response.json();
            if (data.error) {
              console.log('API Error:', JSON.stringify(data.error));
              return 'Error calling Claude API: ' + data.error.message;
            }
            return data.content[0].text;
          result-encoding: string

      - name: Post Review Comments
        uses: actions/github-script@v7
        env:
          SECURITY_RESULT: ${{ steps.security.outputs.result }}
          ARCHITECTURE_RESULT: ${{ steps.architecture.outputs.result }}
          QUALITY_RESULT: ${{ steps.quality.outputs.result }}
        with:
          script: |
            const security = process.env.SECURITY_RESULT;
            const architecture = process.env.ARCHITECTURE_RESULT;
            const quality = process.env.QUALITY_RESULT;

            const body = [
              '## ü§ñ Claude Code Review',
              '',
              '### üîí Security',
              security,
              '',
              '### üèóÔ∏è Architecture',
              architecture,
              '',
              '### ‚ú® Code Quality',
              quality,
              '',
              '---',
              '*Triggered by /review command*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
